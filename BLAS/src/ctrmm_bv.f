C        Generated by TAPENADE     (INRIA, Ecuador team)
C  Tapenade 3.16 (develop) -  6 Jan 2026 19:07
C
C  Differentiation of ctrmm in reverse (adjoint) mode (with options multiDirectional):
C   gradient     of useful results: b
C   with respect to varying inputs: alpha a b
C   RW status of diff variables: alpha:out a:out b:in-out
C> \brief \b CTRMM
C
C  =========== DOCUMENTATION ===========
C
C Online html documentation available at
C            http://www.netlib.org/lapack/explore-html/
C
C  Definition:
C  ===========
C
C       SUBROUTINE CTRMM(SIDE,UPLO,TRANSA,DIAG,M,N,ALPHA,A,LDA,B,LDB)
C
C       .. Scalar Arguments ..
C       COMPLEX ALPHA
C       INTEGER LDA,LDB,M,N
C       CHARACTER DIAG,SIDE,TRANSA,UPLO
C       ..
C       .. Array Arguments ..
C       COMPLEX A(LDA,*),B(LDB,*)
C       ..
C
C
C> \par Purpose:
C  =============
C>
C> \verbatim
C>
C> CTRMM  performs one of the matrix-matrix operations
C>
C>    B := alpha*op( A )*B,   or   B := alpha*B*op( A )
C>
C> where  alpha  is a scalar,  B  is an m by n matrix,  A  is a unit, or
C> non-unit,  upper or lower triangular matrix  and  op( A )  is one  of
C>
C>    op( A ) = A   or   op( A ) = A**T   or   op( A ) = A**H.
C> \endverbatim
C
C  Arguments:
C  ==========
C
C> \param[in] SIDE
C> \verbatim
C>          SIDE is CHARACTER*1
C>           On entry,  SIDE specifies whether  op( A ) multiplies B from
C>           the left or right as follows:
C>
C>              SIDE = 'L' or 'l'   B := alpha*op( A )*B.
C>
C>              SIDE = 'R' or 'r'   B := alpha*B*op( A ).
C> \endverbatim
C>
C> \param[in] UPLO
C> \verbatim
C>          UPLO is CHARACTER*1
C>           On entry, UPLO specifies whether the matrix A is an upper or
C>           lower triangular matrix as follows:
C>
C>              UPLO = 'U' or 'u'   A is an upper triangular matrix.
C>
C>              UPLO = 'L' or 'l'   A is a lower triangular matrix.
C> \endverbatim
C>
C> \param[in] TRANSA
C> \verbatim
C>          TRANSA is CHARACTER*1
C>           On entry, TRANSA specifies the form of op( A ) to be used in
C>           the matrix multiplication as follows:
C>
C>              TRANSA = 'N' or 'n'   op( A ) = A.
C>
C>              TRANSA = 'T' or 't'   op( A ) = A**T.
C>
C>              TRANSA = 'C' or 'c'   op( A ) = A**H.
C> \endverbatim
C>
C> \param[in] DIAG
C> \verbatim
C>          DIAG is CHARACTER*1
C>           On entry, DIAG specifies whether or not A is unit triangular
C>           as follows:
C>
C>              DIAG = 'U' or 'u'   A is assumed to be unit triangular.
C>
C>              DIAG = 'N' or 'n'   A is not assumed to be unit
C>                                  triangular.
C> \endverbatim
C>
C> \param[in] M
C> \verbatim
C>          M is INTEGER
C>           On entry, M specifies the number of rows of B. M must be at
C>           least zero.
C> \endverbatim
C>
C> \param[in] N
C> \verbatim
C>          N is INTEGER
C>           On entry, N specifies the number of columns of B.  N must be
C>           at least zero.
C> \endverbatim
C>
C> \param[in] ALPHA
C> \verbatim
C>          ALPHA is COMPLEX
C>           On entry,  ALPHA specifies the scalar  alpha. When  alpha is
C>           zero then  A is not referenced and  B need not be set before
C>           entry.
C> \endverbatim
C>
C> \param[in] A
C> \verbatim
C>          A is COMPLEX array, dimension ( LDA, k ), where k is m
C>           when  SIDE = 'L' or 'l'  and is  n  when  SIDE = 'R' or 'r'.
C>           Before entry  with  UPLO = 'U' or 'u',  the  leading  k by k
C>           upper triangular part of the array  A must contain the upper
C>           triangular matrix  and the strictly lower triangular part of
C>           A is not referenced.
C>           Before entry  with  UPLO = 'L' or 'l',  the  leading  k by k
C>           lower triangular part of the array  A must contain the lower
C>           triangular matrix  and the strictly upper triangular part of
C>           A is not referenced.
C>           Note that when  DIAG = 'U' or 'u',  the diagonal elements of
C>           A  are not referenced either,  but are assumed to be  unity.
C> \endverbatim
C>
C> \param[in] LDA
C> \verbatim
C>          LDA is INTEGER
C>           On entry, LDA specifies the first dimension of A as declared
C>           in the calling (sub) program.  When  SIDE = 'L' or 'l'  then
C>           LDA  must be at least  max( 1, m ),  when  SIDE = 'R' or 'r'
C>           then LDA must be at least max( 1, n ).
C> \endverbatim
C>
C> \param[in,out] B
C> \verbatim
C>          B is COMPLEX array, dimension ( LDB, N ).
C>           Before entry,  the leading  m by n part of the array  B must
C>           contain the matrix  B,  and  on exit  is overwritten  by the
C>           transformed matrix.
C> \endverbatim
C>
C> \param[in] LDB
C> \verbatim
C>          LDB is INTEGER
C>           On entry, LDB specifies the first dimension of B as declared
C>           in  the  calling  (sub)  program.   LDB  must  be  at  least
C>           max( 1, m ).
C> \endverbatim
C
C  Authors:
C  ========
C
C> \author Univ. of Tennessee
C> \author Univ. of California Berkeley
C> \author Univ. of Colorado Denver
C> \author NAG Ltd.
C
C> \ingroup trmm
C
C> \par Further Details:
C  =====================
C>
C> \verbatim
C>
C>  Level 3 Blas routine.
C>
C>  -- Written on 8-February-1989.
C>     Jack Dongarra, Argonne National Laboratory.
C>     Iain Duff, AERE Harwell.
C>     Jeremy Du Croz, Numerical Algorithms Group Ltd.
C>     Sven Hammarling, Numerical Algorithms Group Ltd.
C> \endverbatim
C>
C  =====================================================================
      SUBROUTINE CTRMM_BV(side, uplo, transa, diag, m, n, alpha, alphab
     +                    , a, ab, lda, b, bb, ldb, nbdirs)
      IMPLICIT NONE
      INCLUDE 'DIFFSIZES.inc'
C  Hint: ISIZE2OFa should be the size of dimension 2 of array a
C  Hint: nbdirsmax should be the maximum number of differentiation directions
C
C  -- Reference BLAS level3 routine --
C  -- Reference BLAS is a software package provided by Univ. of Tennessee,    --
C  -- Univ. of California Berkeley, Univ. of Colorado Denver and NAG Ltd..--
C
C     .. Scalar Arguments ..
      COMPLEX alpha
      COMPLEX alphab(nbdirsmax)
      INTEGER lda, ldb, m, n
      CHARACTER diag, side, transa, uplo
C     ..
C     .. Array Arguments ..
      COMPLEX a(lda, *), b(ldb, *)
      COMPLEX ab(nbdirsmax, lda, *), bb(nbdirsmax, ldb, *)
      EXTERNAL LSAME
C     ..
C
C  =====================================================================
C
C     .. External Functions ..
      INTEGER get_ISIZE2OFA
      EXTERNAL get_ISIZE2OFA
      LOGICAL LSAME
C     ..
C     .. External Subroutines ..
      EXTERNAL XERBLA, check_ISIZE2OFA_initialized
C     ..
C     .. Intrinsic Functions ..
      INTRINSIC CONJG, MAX
C     ..
C     .. Local Scalars ..
      COMPLEX temp
      COMPLEX tempb(nbdirsmax)
      INTEGER i, info, j, k, nrowa
      LOGICAL lside, noconj, nounit, upper
      INTEGER ISIZE2OFA
C     ..
C     .. Parameters ..
      COMPLEX one
      PARAMETER (one=(1.0e+0,0.0e+0))
      COMPLEX zero
      PARAMETER (zero=(0.0e+0,0.0e+0))
      INTEGER max1
      INTEGER max2
      INTEGER nd
      COMPLEX tmp
      COMPLEX tmpb(nbdirsmax)
      COMPLEX tmp0
      COMPLEX tmpb0(nbdirsmax)
      COMPLEX tmp1
      COMPLEX tmpb1(nbdirsmax)
      COMPLEX tmp2
      COMPLEX tmpb2(nbdirsmax)
      INTEGER ad_to
      INTEGER*4 branch
      INTEGER ad_from
      INTEGER ad_to0
      INTEGER ad_to1
      INTEGER ad_from0
      INTEGER ad_from1
      INTEGER ad_to2
      INTEGER ad_from2
      INTEGER ad_to3
      INTEGER ad_from3
      INTEGER ii2
      INTEGER ii1
      INTEGER nbdirs
C     ..
C
C     Test the input parameters.
C
C     Check 0 < nbdirs <= nbdirsmax (required by DIFFSIZES.inc)
      CALL check_ISIZE2OFA_initialized()
      ISIZE2OFA = get_ISIZE2OFA()
      IF (nbdirs.LE.0 .OR. nbdirs.GT.nbdirsmax) THEN
        WRITE(*,'(A,I0,A,I0,A)') 'Error: nbdirs=', nbdirs,
     +  ' must be in 1..nbdirsmax=', nbdirsmax, '. Stopping.'
        STOP 1
      END IF
C
      lside = LSAME(side, 'L')
      IF (lside) THEN
        nrowa = m
      ELSE
        nrowa = n
      END IF
      noconj = LSAME(transa, 'T')
      nounit = LSAME(diag, 'N')
      upper = LSAME(uplo, 'U')
C
      info = 0
      IF (.NOT.lside .AND. (.NOT.LSAME(side, 'R'))) THEN
        CALL PUSHCONTROL3B(0)
        info = 1
      ELSE IF (.NOT.upper .AND. (.NOT.LSAME(uplo, 'L'))) THEN
        CALL PUSHCONTROL3B(1)
        info = 2
      ELSE IF (.NOT.LSAME(transa, 'N') .AND. (.NOT.LSAME(transa, 'T')) 
     +    .AND. (.NOT.LSAME(transa, 'C'))) THEN
        CALL PUSHCONTROL3B(2)
        info = 3
      ELSE IF (.NOT.LSAME(diag, 'U') .AND. (.NOT.LSAME(diag, 'N'))) THEN
        CALL PUSHCONTROL3B(3)
        info = 4
      ELSE IF (m .LT. 0) THEN
        CALL PUSHCONTROL3B(4)
        info = 5
      ELSE IF (n .LT. 0) THEN
        CALL PUSHCONTROL3B(5)
        info = 6
      ELSE
        IF (1 .LT. nrowa) THEN
          max1 = nrowa
        ELSE
          max1 = 1
        END IF
        IF (lda .LT. max1) THEN
          CALL PUSHCONTROL3B(6)
          info = 9
        ELSE
          IF (1 .LT. m) THEN
            max2 = m
          ELSE
            max2 = 1
          END IF
          IF (ldb .LT. max2) THEN
            CALL PUSHCONTROL3B(7)
            info = 11
          ELSE
            CALL PUSHCONTROL3B(7)
          END IF
        END IF
      END IF
      IF (info .EQ. 0) THEN
C
C     Quick return if possible.
C
        IF (m .EQ. 0 .OR. n .EQ. 0) THEN
          DO nd=1,nbdirsmax
            alphab(nd) = (0.0,0.0)
          ENDDO
          DO ii1=1,ISIZE2OFa
            DO ii2=1,lda
              DO nd=1,nbdirsmax
                ab(nd, ii2, ii1) = (0.0,0.0)
              ENDDO
            ENDDO
          ENDDO
        ELSE IF (alpha .EQ. zero) THEN
C
C     And when  alpha.eq.zero.
C
          DO j=n,1,-1
            DO i=m,1,-1
              DO nd=1,nbdirs
                bb(nd, i, j) = (0.0,0.0)
              ENDDO
            ENDDO
          ENDDO
          DO nd=1,nbdirsmax
            alphab(nd) = (0.0,0.0)
          ENDDO
          DO ii1=1,ISIZE2OFa
            DO ii2=1,lda
              DO nd=1,nbdirsmax
                ab(nd, ii2, ii1) = (0.0,0.0)
              ENDDO
            ENDDO
          ENDDO
        ELSE IF (lside) THEN
C
C     Start the operations.
C
          IF (LSAME(transa, 'N')) THEN
C
C           Form  B := alpha*A*B.
C
            IF (upper) THEN
              DO j=1,n
                DO k=1,m
                  IF (b(k, j) .NE. zero) THEN
                    CALL PUSHCOMPLEX8(temp)
                    temp = alpha*b(k, j)
                    DO i=1,k-1
                      CALL PUSHCOMPLEX8(b(i, j))
                      b(i, j) = b(i, j) + temp*a(i, k)
                    ENDDO
                    CALL PUSHINTEGER4(i - 1)
                    IF (nounit) THEN
                      CALL PUSHCOMPLEX8(temp)
                      temp = temp*a(k, k)
                      CALL PUSHCONTROL1B(0)
                    ELSE
                      CALL PUSHCONTROL1B(1)
                    END IF
                    CALL PUSHCOMPLEX8(b(k, j))
                    b(k, j) = temp
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    CALL PUSHCONTROL1B(1)
                  END IF
                ENDDO
              ENDDO
              DO nd=1,nbdirsmax
                alphab(nd) = (0.0,0.0)
              ENDDO
              DO ii1=1,ISIZE2OFa
                DO ii2=1,lda
                  DO nd=1,nbdirsmax
                    ab(nd, ii2, ii1) = (0.0,0.0)
                  ENDDO
                ENDDO
              ENDDO
              DO j=n,1,-1
                DO k=m,1,-1
                  CALL POPCONTROL1B(branch)
                  IF (branch .EQ. 0) THEN
                    CALL POPCOMPLEX8(b(k, j))
                    DO nd=1,nbdirs
                      tempb(nd) = bb(nd, k, j)
                      bb(nd, k, j) = (0.0,0.0)
                    ENDDO
                    CALL POPCONTROL1B(branch)
                    IF (branch .EQ. 0) THEN
                      CALL POPCOMPLEX8(temp)
                      DO nd=1,nbdirs
                        ab(nd, k, k) = ab(nd, k, k) + CONJG(temp)*tempb(
     +                    nd)
                        tempb(nd) = CONJG(a(k, k))*tempb(nd)
                      ENDDO
                    END IF
                    CALL POPINTEGER4(ad_to)
                    DO i=ad_to,1,-1
                      CALL POPCOMPLEX8(b(i, j))
                      DO nd=1,nbdirs
                        tempb(nd) = tempb(nd) + CONJG(a(i, k))*bb(nd, i
     +                    , j)
                        ab(nd, i, k) = ab(nd, i, k) + CONJG(temp)*bb(nd
     +                    , i, j)
                      ENDDO
                    ENDDO
                    CALL POPCOMPLEX8(temp)
                    DO nd=1,nbdirs
                      alphab(nd) = alphab(nd) + CONJG(b(k, j))*tempb(nd)
                      bb(nd, k, j) = bb(nd, k, j) + CONJG(alpha)*tempb(
     +                  nd)
                    ENDDO
                  END IF
                ENDDO
              ENDDO
            ELSE
              DO j=1,n
                DO k=m,1,-1
                  IF (b(k, j) .NE. zero) THEN
                    CALL PUSHCOMPLEX8(temp)
                    temp = alpha*b(k, j)
                    CALL PUSHCOMPLEX8(b(k, j))
                    b(k, j) = temp
                    IF (nounit) THEN
                      CALL PUSHCOMPLEX8(b(k, j))
                      b(k, j) = b(k, j)*a(k, k)
                      CALL PUSHCONTROL1B(1)
                    ELSE
                      CALL PUSHCONTROL1B(0)
                    END IF
                    ad_from = k + 1
                    DO i=ad_from,m
                      CALL PUSHCOMPLEX8(b(i, j))
                      b(i, j) = b(i, j) + temp*a(i, k)
                    ENDDO
                    CALL PUSHINTEGER4(ad_from)
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    CALL PUSHCONTROL1B(1)
                  END IF
                ENDDO
              ENDDO
              DO nd=1,nbdirsmax
                alphab(nd) = (0.0,0.0)
              ENDDO
              DO ii1=1,ISIZE2OFa
                DO ii2=1,lda
                  DO nd=1,nbdirsmax
                    ab(nd, ii2, ii1) = (0.0,0.0)
                  ENDDO
                ENDDO
              ENDDO
              DO j=n,1,-1
                DO k=1,m,1
                  CALL POPCONTROL1B(branch)
                  IF (branch .EQ. 0) THEN
                    DO nd=1,nbdirsmax
                      tempb(nd) = (0.0,0.0)
                    ENDDO
                    CALL POPINTEGER4(ad_from)
                    DO i=m,ad_from,-1
                      CALL POPCOMPLEX8(b(i, j))
                      DO nd=1,nbdirs
                        tempb(nd) = tempb(nd) + CONJG(a(i, k))*bb(nd, i
     +                    , j)
                        ab(nd, i, k) = ab(nd, i, k) + CONJG(temp)*bb(nd
     +                    , i, j)
                      ENDDO
                    ENDDO
                    CALL POPCONTROL1B(branch)
                    IF (branch .NE. 0) THEN
                      CALL POPCOMPLEX8(b(k, j))
                      DO nd=1,nbdirs
                        ab(nd, k, k) = ab(nd, k, k) + CONJG(b(k, j))*bb(
     +                    nd, k, j)
                        bb(nd, k, j) = CONJG(a(k, k))*bb(nd, k, j)
                      ENDDO
                    END IF
                    CALL POPCOMPLEX8(b(k, j))
                    CALL POPCOMPLEX8(temp)
                    DO nd=1,nbdirs
                      tempb(nd) = tempb(nd) + bb(nd, k, j)
                      bb(nd, k, j) = CONJG(alpha)*tempb(nd)
                      alphab(nd) = alphab(nd) + CONJG(b(k, j))*tempb(nd)
                    ENDDO
                  END IF
                ENDDO
              ENDDO
            END IF
          ELSE IF (upper) THEN
C
C           Form  B := alpha*A**T*B   or   B := alpha*A**H*B.
C
            DO j=1,n
              DO i=m,1,-1
                CALL PUSHCOMPLEX8(temp)
                temp = b(i, j)
                IF (noconj) THEN
                  IF (nounit) THEN
                    CALL PUSHCOMPLEX8(temp)
                    temp = temp*a(i, i)
                    CALL PUSHCONTROL1B(1)
                  ELSE
                    CALL PUSHCONTROL1B(0)
                  END IF
                  DO k=1,i-1
                    temp = temp + a(k, i)*b(k, j)
                  ENDDO
                  CALL PUSHINTEGER4(k - 1)
                  CALL PUSHCONTROL1B(0)
                ELSE
                  IF (nounit) THEN
                    CALL PUSHCOMPLEX8(temp)
                    temp = temp*CONJG(a(i, i))
                    CALL PUSHCONTROL1B(1)
                  ELSE
                    CALL PUSHCONTROL1B(0)
                  END IF
                  DO k=1,i-1
                    temp = temp + CONJG(a(k, i))*b(k, j)
                  ENDDO
                  CALL PUSHINTEGER4(k - 1)
                  CALL PUSHCONTROL1B(1)
                END IF
                CALL PUSHCOMPLEX8(b(i, j))
                b(i, j) = alpha*temp
              ENDDO
            ENDDO
            DO nd=1,nbdirsmax
              alphab(nd) = (0.0,0.0)
            ENDDO
            DO ii1=1,ISIZE2OFa
              DO ii2=1,lda
                DO nd=1,nbdirsmax
                  ab(nd, ii2, ii1) = (0.0,0.0)
                ENDDO
              ENDDO
            ENDDO
            DO j=n,1,-1
              DO i=1,m,1
                CALL POPCOMPLEX8(b(i, j))
                DO nd=1,nbdirs
                  alphab(nd) = alphab(nd) + CONJG(temp)*bb(nd, i, j)
                  tempb(nd) = CONJG(alpha)*bb(nd, i, j)
                  bb(nd, i, j) = (0.0,0.0)
                ENDDO
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  CALL POPINTEGER4(ad_to0)
                  DO k=ad_to0,1,-1
                    DO nd=1,nbdirs
                      ab(nd, k, i) = ab(nd, k, i) + CONJG(b(k, j))*tempb
     +                  (nd)
                      bb(nd, k, j) = bb(nd, k, j) + CONJG(a(k, i))*tempb
     +                  (nd)
                    ENDDO
                  ENDDO
                  CALL POPCONTROL1B(branch)
                  IF (branch .NE. 0) THEN
                    CALL POPCOMPLEX8(temp)
                    DO nd=1,nbdirs
                      ab(nd, i, i) = ab(nd, i, i) + CONJG(temp)*tempb(nd
     +                  )
                      tempb(nd) = CONJG(a(i, i))*tempb(nd)
                    ENDDO
                  END IF
                ELSE
                  CALL POPINTEGER4(ad_to1)
                  DO k=ad_to1,1,-1
                    DO nd=1,nbdirs
                      ab(nd, k, i) = ab(nd, k, i) + CONJG(CONJG(b(k, j))
     +                  *tempb(nd))
                      bb(nd, k, j) = bb(nd, k, j) + CONJG(CONJG(a(k, i))
     +                  )*tempb(nd)
                    ENDDO
                  ENDDO
                  CALL POPCONTROL1B(branch)
                  IF (branch .NE. 0) THEN
                    CALL POPCOMPLEX8(temp)
                    DO nd=1,nbdirs
                      ab(nd, i, i) = ab(nd, i, i) + CONJG(CONJG(temp)*
     +                  tempb(nd))
                      tempb(nd) = CONJG(CONJG(a(i, i)))*tempb(nd)
                    ENDDO
                  END IF
                END IF
                CALL POPCOMPLEX8(temp)
                DO nd=1,nbdirs
                  bb(nd, i, j) = bb(nd, i, j) + tempb(nd)
                ENDDO
              ENDDO
            ENDDO
          ELSE
            DO j=1,n
              DO i=1,m
                CALL PUSHCOMPLEX8(temp)
                temp = b(i, j)
                IF (noconj) THEN
                  IF (nounit) THEN
                    CALL PUSHCOMPLEX8(temp)
                    temp = temp*a(i, i)
                    CALL PUSHCONTROL1B(1)
                  ELSE
                    CALL PUSHCONTROL1B(0)
                  END IF
                  ad_from0 = i + 1
                  DO k=ad_from0,m
                    temp = temp + a(k, i)*b(k, j)
                  ENDDO
                  CALL PUSHINTEGER4(ad_from0)
                  CALL PUSHCONTROL1B(0)
                ELSE
                  IF (nounit) THEN
                    CALL PUSHCOMPLEX8(temp)
                    temp = temp*CONJG(a(i, i))
                    CALL PUSHCONTROL1B(1)
                  ELSE
                    CALL PUSHCONTROL1B(0)
                  END IF
                  ad_from1 = i + 1
                  DO k=ad_from1,m
                    temp = temp + CONJG(a(k, i))*b(k, j)
                  ENDDO
                  CALL PUSHINTEGER4(ad_from1)
                  CALL PUSHCONTROL1B(1)
                END IF
                CALL PUSHCOMPLEX8(b(i, j))
                b(i, j) = alpha*temp
              ENDDO
            ENDDO
            DO nd=1,nbdirsmax
              alphab(nd) = (0.0,0.0)
            ENDDO
            DO ii1=1,ISIZE2OFa
              DO ii2=1,lda
                DO nd=1,nbdirsmax
                  ab(nd, ii2, ii1) = (0.0,0.0)
                ENDDO
              ENDDO
            ENDDO
            DO j=n,1,-1
              DO i=m,1,-1
                CALL POPCOMPLEX8(b(i, j))
                DO nd=1,nbdirs
                  alphab(nd) = alphab(nd) + CONJG(temp)*bb(nd, i, j)
                  tempb(nd) = CONJG(alpha)*bb(nd, i, j)
                  bb(nd, i, j) = (0.0,0.0)
                ENDDO
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  CALL POPINTEGER4(ad_from0)
                  DO k=m,ad_from0,-1
                    DO nd=1,nbdirs
                      ab(nd, k, i) = ab(nd, k, i) + CONJG(b(k, j))*tempb
     +                  (nd)
                      bb(nd, k, j) = bb(nd, k, j) + CONJG(a(k, i))*tempb
     +                  (nd)
                    ENDDO
                  ENDDO
                  CALL POPCONTROL1B(branch)
                  IF (branch .NE. 0) THEN
                    CALL POPCOMPLEX8(temp)
                    DO nd=1,nbdirs
                      ab(nd, i, i) = ab(nd, i, i) + CONJG(temp)*tempb(nd
     +                  )
                      tempb(nd) = CONJG(a(i, i))*tempb(nd)
                    ENDDO
                  END IF
                ELSE
                  CALL POPINTEGER4(ad_from1)
                  DO k=m,ad_from1,-1
                    DO nd=1,nbdirs
                      ab(nd, k, i) = ab(nd, k, i) + CONJG(CONJG(b(k, j))
     +                  *tempb(nd))
                      bb(nd, k, j) = bb(nd, k, j) + CONJG(CONJG(a(k, i))
     +                  )*tempb(nd)
                    ENDDO
                  ENDDO
                  CALL POPCONTROL1B(branch)
                  IF (branch .NE. 0) THEN
                    CALL POPCOMPLEX8(temp)
                    DO nd=1,nbdirs
                      ab(nd, i, i) = ab(nd, i, i) + CONJG(CONJG(temp)*
     +                  tempb(nd))
                      tempb(nd) = CONJG(CONJG(a(i, i)))*tempb(nd)
                    ENDDO
                  END IF
                END IF
                CALL POPCOMPLEX8(temp)
                DO nd=1,nbdirs
                  bb(nd, i, j) = bb(nd, i, j) + tempb(nd)
                ENDDO
              ENDDO
            ENDDO
          END IF
        ELSE IF (LSAME(transa, 'N')) THEN
C
C           Form  B := alpha*B*A.
C
          IF (upper) THEN
            DO j=n,1,-1
              CALL PUSHCOMPLEX8(temp)
              temp = alpha
              IF (nounit) THEN
                CALL PUSHCOMPLEX8(temp)
                temp = temp*a(j, j)
                CALL PUSHCONTROL1B(1)
              ELSE
                CALL PUSHCONTROL1B(0)
              END IF
              DO i=1,m
                CALL PUSHCOMPLEX8(b(i, j))
                b(i, j) = temp*b(i, j)
              ENDDO
              DO k=1,j-1
                IF (a(k, j) .NE. zero) THEN
                  CALL PUSHCOMPLEX8(temp)
                  temp = alpha*a(k, j)
                  DO i=1,m
                    tmp = b(i, j) + temp*b(i, k)
                    CALL PUSHCOMPLEX8(b(i, j))
                    b(i, j) = tmp
                  ENDDO
                  CALL PUSHCONTROL1B(0)
                ELSE
                  CALL PUSHCONTROL1B(1)
                END IF
              ENDDO
              CALL PUSHINTEGER4(k - 1)
            ENDDO
            DO nd=1,nbdirsmax
              alphab(nd) = (0.0,0.0)
            ENDDO
            DO ii1=1,ISIZE2OFa
              DO ii2=1,lda
                DO nd=1,nbdirsmax
                  ab(nd, ii2, ii1) = (0.0,0.0)
                ENDDO
              ENDDO
            ENDDO
            DO j=1,n,1
              CALL POPINTEGER4(ad_to2)
              DO k=ad_to2,1,-1
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  DO nd=1,nbdirsmax
                    tempb(nd) = (0.0,0.0)
                  ENDDO
                  DO i=m,1,-1
                    CALL POPCOMPLEX8(b(i, j))
                    DO nd=1,nbdirs
                      tmpb(nd) = bb(nd, i, j)
                      bb(nd, i, j) = tmpb(nd)
                      tempb(nd) = tempb(nd) + CONJG(b(i, k))*tmpb(nd)
                      bb(nd, i, k) = bb(nd, i, k) + CONJG(temp)*tmpb(nd)
                    ENDDO
                  ENDDO
                  CALL POPCOMPLEX8(temp)
                  DO nd=1,nbdirs
                    alphab(nd) = alphab(nd) + CONJG(a(k, j))*tempb(nd)
                    ab(nd, k, j) = ab(nd, k, j) + CONJG(alpha)*tempb(nd)
                  ENDDO
                END IF
              ENDDO
              DO nd=1,nbdirsmax
                tempb(nd) = (0.0,0.0)
              ENDDO
              DO i=m,1,-1
                CALL POPCOMPLEX8(b(i, j))
                DO nd=1,nbdirs
                  tempb(nd) = tempb(nd) + CONJG(b(i, j))*bb(nd, i, j)
                  bb(nd, i, j) = CONJG(temp)*bb(nd, i, j)
                ENDDO
              ENDDO
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) THEN
                CALL POPCOMPLEX8(temp)
                DO nd=1,nbdirs
                  ab(nd, j, j) = ab(nd, j, j) + CONJG(temp)*tempb(nd)
                  tempb(nd) = CONJG(a(j, j))*tempb(nd)
                ENDDO
              END IF
              CALL POPCOMPLEX8(temp)
              DO nd=1,nbdirs
                alphab(nd) = alphab(nd) + tempb(nd)
              ENDDO
            ENDDO
          ELSE
            DO j=1,n
              CALL PUSHCOMPLEX8(temp)
              temp = alpha
              IF (nounit) THEN
                CALL PUSHCOMPLEX8(temp)
                temp = temp*a(j, j)
                CALL PUSHCONTROL1B(1)
              ELSE
                CALL PUSHCONTROL1B(0)
              END IF
              DO i=1,m
                CALL PUSHCOMPLEX8(b(i, j))
                b(i, j) = temp*b(i, j)
              ENDDO
              ad_from2 = j + 1
              DO k=ad_from2,n
                IF (a(k, j) .NE. zero) THEN
                  CALL PUSHCOMPLEX8(temp)
                  temp = alpha*a(k, j)
                  DO i=1,m
                    tmp0 = b(i, j) + temp*b(i, k)
                    CALL PUSHCOMPLEX8(b(i, j))
                    b(i, j) = tmp0
                  ENDDO
                  CALL PUSHCONTROL1B(0)
                ELSE
                  CALL PUSHCONTROL1B(1)
                END IF
              ENDDO
              CALL PUSHINTEGER4(ad_from2)
            ENDDO
            DO nd=1,nbdirsmax
              alphab(nd) = (0.0,0.0)
            ENDDO
            DO ii1=1,ISIZE2OFa
              DO ii2=1,lda
                DO nd=1,nbdirsmax
                  ab(nd, ii2, ii1) = (0.0,0.0)
                ENDDO
              ENDDO
            ENDDO
            DO j=n,1,-1
              CALL POPINTEGER4(ad_from2)
              DO k=n,ad_from2,-1
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  DO nd=1,nbdirsmax
                    tempb(nd) = (0.0,0.0)
                  ENDDO
                  DO i=m,1,-1
                    CALL POPCOMPLEX8(b(i, j))
                    DO nd=1,nbdirs
                      tmpb0(nd) = bb(nd, i, j)
                      bb(nd, i, j) = tmpb0(nd)
                      tempb(nd) = tempb(nd) + CONJG(b(i, k))*tmpb0(nd)
                      bb(nd, i, k) = bb(nd, i, k) + CONJG(temp)*tmpb0(nd
     +                  )
                    ENDDO
                  ENDDO
                  CALL POPCOMPLEX8(temp)
                  DO nd=1,nbdirs
                    alphab(nd) = alphab(nd) + CONJG(a(k, j))*tempb(nd)
                    ab(nd, k, j) = ab(nd, k, j) + CONJG(alpha)*tempb(nd)
                  ENDDO
                END IF
              ENDDO
              DO nd=1,nbdirsmax
                tempb(nd) = (0.0,0.0)
              ENDDO
              DO i=m,1,-1
                CALL POPCOMPLEX8(b(i, j))
                DO nd=1,nbdirs
                  tempb(nd) = tempb(nd) + CONJG(b(i, j))*bb(nd, i, j)
                  bb(nd, i, j) = CONJG(temp)*bb(nd, i, j)
                ENDDO
              ENDDO
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) THEN
                CALL POPCOMPLEX8(temp)
                DO nd=1,nbdirs
                  ab(nd, j, j) = ab(nd, j, j) + CONJG(temp)*tempb(nd)
                  tempb(nd) = CONJG(a(j, j))*tempb(nd)
                ENDDO
              END IF
              CALL POPCOMPLEX8(temp)
              DO nd=1,nbdirs
                alphab(nd) = alphab(nd) + tempb(nd)
              ENDDO
            ENDDO
          END IF
        ELSE IF (upper) THEN
C
C           Form  B := alpha*B*A**T   or   B := alpha*B*A**H.
C
          DO k=1,n
            DO j=1,k-1
              IF (a(j, k) .NE. zero) THEN
                IF (noconj) THEN
                  CALL PUSHCOMPLEX8(temp)
                  temp = alpha*a(j, k)
                  CALL PUSHCONTROL1B(1)
                ELSE
                  CALL PUSHCOMPLEX8(temp)
                  temp = alpha*CONJG(a(j, k))
                  CALL PUSHCONTROL1B(0)
                END IF
                DO i=1,m
                  tmp1 = b(i, j) + temp*b(i, k)
                  CALL PUSHCOMPLEX8(b(i, j))
                  b(i, j) = tmp1
                ENDDO
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHCONTROL1B(1)
              END IF
            ENDDO
            CALL PUSHINTEGER4(j - 1)
            CALL PUSHCOMPLEX8(temp)
            temp = alpha
            IF (nounit) THEN
              IF (noconj) THEN
                CALL PUSHCOMPLEX8(temp)
                temp = temp*a(k, k)
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHCOMPLEX8(temp)
                temp = temp*CONJG(a(k, k))
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE
              CALL PUSHCONTROL2B(2)
            END IF
            IF (temp .NE. one) THEN
              DO i=1,m
                CALL PUSHCOMPLEX8(b(i, k))
                b(i, k) = temp*b(i, k)
              ENDDO
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHCONTROL1B(1)
            END IF
          ENDDO
          DO nd=1,nbdirsmax
            alphab(nd) = (0.0,0.0)
          ENDDO
          DO ii1=1,ISIZE2OFa
            DO ii2=1,lda
              DO nd=1,nbdirsmax
                ab(nd, ii2, ii1) = (0.0,0.0)
              ENDDO
            ENDDO
          ENDDO
          DO k=n,1,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              DO nd=1,nbdirsmax
                tempb(nd) = (0.0,0.0)
              ENDDO
              DO i=m,1,-1
                CALL POPCOMPLEX8(b(i, k))
                DO nd=1,nbdirs
                  tempb(nd) = tempb(nd) + CONJG(b(i, k))*bb(nd, i, k)
                  bb(nd, i, k) = CONJG(temp)*bb(nd, i, k)
                ENDDO
              ENDDO
            ELSE
              DO nd=1,nbdirsmax
                tempb(nd) = (0.0,0.0)
              ENDDO
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPCOMPLEX8(temp)
              DO nd=1,nbdirs
                ab(nd, k, k) = ab(nd, k, k) + CONJG(temp)*tempb(nd)
                tempb(nd) = CONJG(a(k, k))*tempb(nd)
              ENDDO
            ELSE IF (branch .EQ. 1) THEN
              CALL POPCOMPLEX8(temp)
              DO nd=1,nbdirs
                ab(nd, k, k) = ab(nd, k, k) + CONJG(CONJG(temp)*tempb(nd
     +            ))
                tempb(nd) = CONJG(CONJG(a(k, k)))*tempb(nd)
              ENDDO
            END IF
            CALL POPCOMPLEX8(temp)
            DO nd=1,nbdirs
              alphab(nd) = alphab(nd) + tempb(nd)
            ENDDO
            CALL POPINTEGER4(ad_to3)
            DO j=ad_to3,1,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                DO nd=1,nbdirsmax
                  tempb(nd) = (0.0,0.0)
                ENDDO
                DO i=m,1,-1
                  CALL POPCOMPLEX8(b(i, j))
                  DO nd=1,nbdirs
                    tmpb1(nd) = bb(nd, i, j)
                    bb(nd, i, j) = tmpb1(nd)
                    tempb(nd) = tempb(nd) + CONJG(b(i, k))*tmpb1(nd)
                    bb(nd, i, k) = bb(nd, i, k) + CONJG(temp)*tmpb1(nd)
                  ENDDO
                ENDDO
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  CALL POPCOMPLEX8(temp)
                  DO nd=1,nbdirs
                    alphab(nd) = alphab(nd) + CONJG(CONJG(a(j, k)))*
     +                tempb(nd)
                    ab(nd, j, k) = ab(nd, j, k) + CONJG(CONJG(alpha)*
     +                tempb(nd))
                  ENDDO
                ELSE
                  CALL POPCOMPLEX8(temp)
                  DO nd=1,nbdirs
                    alphab(nd) = alphab(nd) + CONJG(a(j, k))*tempb(nd)
                    ab(nd, j, k) = ab(nd, j, k) + CONJG(alpha)*tempb(nd)
                  ENDDO
                END IF
              END IF
            ENDDO
          ENDDO
        ELSE
          DO k=n,1,-1
            ad_from3 = k + 1
            DO j=ad_from3,n
              IF (a(j, k) .NE. zero) THEN
                IF (noconj) THEN
                  CALL PUSHCOMPLEX8(temp)
                  temp = alpha*a(j, k)
                  CALL PUSHCONTROL1B(1)
                ELSE
                  CALL PUSHCOMPLEX8(temp)
                  temp = alpha*CONJG(a(j, k))
                  CALL PUSHCONTROL1B(0)
                END IF
                DO i=1,m
                  tmp2 = b(i, j) + temp*b(i, k)
                  CALL PUSHCOMPLEX8(b(i, j))
                  b(i, j) = tmp2
                ENDDO
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHCONTROL1B(1)
              END IF
            ENDDO
            CALL PUSHINTEGER4(ad_from3)
            CALL PUSHCOMPLEX8(temp)
            temp = alpha
            IF (nounit) THEN
              IF (noconj) THEN
                CALL PUSHCOMPLEX8(temp)
                temp = temp*a(k, k)
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHCOMPLEX8(temp)
                temp = temp*CONJG(a(k, k))
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE
              CALL PUSHCONTROL2B(2)
            END IF
            IF (temp .NE. one) THEN
              DO i=1,m
                CALL PUSHCOMPLEX8(b(i, k))
                b(i, k) = temp*b(i, k)
              ENDDO
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHCONTROL1B(1)
            END IF
          ENDDO
          DO nd=1,nbdirsmax
            alphab(nd) = (0.0,0.0)
          ENDDO
          DO ii1=1,ISIZE2OFa
            DO ii2=1,lda
              DO nd=1,nbdirsmax
                ab(nd, ii2, ii1) = (0.0,0.0)
              ENDDO
            ENDDO
          ENDDO
          DO k=1,n,1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              DO nd=1,nbdirsmax
                tempb(nd) = (0.0,0.0)
              ENDDO
              DO i=m,1,-1
                CALL POPCOMPLEX8(b(i, k))
                DO nd=1,nbdirs
                  tempb(nd) = tempb(nd) + CONJG(b(i, k))*bb(nd, i, k)
                  bb(nd, i, k) = CONJG(temp)*bb(nd, i, k)
                ENDDO
              ENDDO
            ELSE
              DO nd=1,nbdirsmax
                tempb(nd) = (0.0,0.0)
              ENDDO
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPCOMPLEX8(temp)
              DO nd=1,nbdirs
                ab(nd, k, k) = ab(nd, k, k) + CONJG(temp)*tempb(nd)
                tempb(nd) = CONJG(a(k, k))*tempb(nd)
              ENDDO
            ELSE IF (branch .EQ. 1) THEN
              CALL POPCOMPLEX8(temp)
              DO nd=1,nbdirs
                ab(nd, k, k) = ab(nd, k, k) + CONJG(CONJG(temp)*tempb(nd
     +            ))
                tempb(nd) = CONJG(CONJG(a(k, k)))*tempb(nd)
              ENDDO
            END IF
            CALL POPCOMPLEX8(temp)
            DO nd=1,nbdirs
              alphab(nd) = alphab(nd) + tempb(nd)
            ENDDO
            CALL POPINTEGER4(ad_from3)
            DO j=n,ad_from3,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                DO nd=1,nbdirsmax
                  tempb(nd) = (0.0,0.0)
                ENDDO
                DO i=m,1,-1
                  CALL POPCOMPLEX8(b(i, j))
                  DO nd=1,nbdirs
                    tmpb2(nd) = bb(nd, i, j)
                    bb(nd, i, j) = tmpb2(nd)
                    tempb(nd) = tempb(nd) + CONJG(b(i, k))*tmpb2(nd)
                    bb(nd, i, k) = bb(nd, i, k) + CONJG(temp)*tmpb2(nd)
                  ENDDO
                ENDDO
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  CALL POPCOMPLEX8(temp)
                  DO nd=1,nbdirs
                    alphab(nd) = alphab(nd) + CONJG(CONJG(a(j, k)))*
     +                tempb(nd)
                    ab(nd, j, k) = ab(nd, j, k) + CONJG(CONJG(alpha)*
     +                tempb(nd))
                  ENDDO
                ELSE
                  CALL POPCOMPLEX8(temp)
                  DO nd=1,nbdirs
                    alphab(nd) = alphab(nd) + CONJG(a(j, k))*tempb(nd)
                    ab(nd, j, k) = ab(nd, j, k) + CONJG(alpha)*tempb(nd)
                  ENDDO
                END IF
              END IF
            ENDDO
          ENDDO
        END IF
      END IF
      CALL POPCONTROL3B(branch)
      END

